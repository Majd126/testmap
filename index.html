<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта экологических катастроф России и СССР</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Контейнер интерфейса */
        .ui-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff4d4d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .year-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Стиль слайдера */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #444;
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ff4d4d;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -9px;
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.8);
            border: 2px solid #fff;
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Стили попапов */
        .leaflet-popup-content-wrapper {
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .leaflet-popup-tip {
            background: rgba(30, 30, 30, 0.95);
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #ff4d4d;
            font-size: 1.1rem;
        }

        .popup-info {
            font-size: 0.9rem;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .popup-meta {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
        }

        .popup-meta span strong {
            color: #fff;
        }

        .popup-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
            background: #222;
        }

        /* Легенда / Статус */
        #status-msg {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="status-msg">Загрузка данных...</div>

    <div class="ui-container">
        <div class="header">
            <h1>Экологические катастрофы</h1>
            <div class="year-display" id="current-year">1900</div>
        </div>
        <input type="range" id="time-slider" min="1900" max="2025" value="2025" step="1">
        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888;">
            <span>1900</span>
            <span>2025</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        // --- 1. Инициализация карты ---
        // Центр на Россию, темная тема
        const map = L.map('map', {
            zoomControl: false,
            minZoom: 2
        }).setView([60.0, 90.0], 3);

        L.control.zoom({ position: 'topleft' }).addTo(map);

        // Используем CartoDB Dark Matter для "современного" вида
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // --- 2. Логика данных ---
        const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRA23xJcb9bXUFBwOuFKuu9_umXwFN7OKIHVYZw21vC_2-FU16EnyK3Ud2sqmI3_S3hDfuf5uGSEqoO/pub?output=xlsx";
        let allEvents = [];
        let markersLayer = L.layerGroup().addTo(map);

        const slider = document.getElementById('time-slider');
        const yearDisplay = document.getElementById('current-year');
        const statusMsg = document.getElementById('status-msg');

        // Функция для расчета радиуса круга в зависимости от жертв
        function getRadius(deathToll) {
            const deaths = parseInt(deathToll) || 0;
            // Базовый размер 5px + логарифмическая шкала.
            // Если жертв 0 или нет данных, будет маленький круг.
            // Если 1000 жертв -> ~15-20px
            if (deaths <= 0) return 60000; // Примерный радиус в метрах для карты
            // Leaflet Circle использует метры. Нам нужно адаптировать под зум или использовать CircleMarker (пиксели).
            // Используем CircleMarker для фиксированного размера в пикселях.
            return 6 + Math.sqrt(deaths) * 0.8; 
        }

        function getColor(deathToll) {
            const deaths = parseInt(deathToll) || 0;
            if (deaths > 1000) return '#ff0000'; // Крупные - ярко красные
            if (deaths > 100) return '#ff4d4d';  // Средние
            return '#ff8c00';                    // Мелкие - оранжевые
        }

        // Загрузка данных
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error("Ошибка сети");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Преобразуем в JSON массив
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                
                // Нормализация данных (убираем пустые, приводим типы)
                allEvents = rawData.map(row => ({
                    title: row.Title || "Без названия",
                    year: parseInt(row.Year) || 1900,
                    lat: parseFloat(row.Lat),
                    lng: parseFloat(row.Lng),
                    desc: row.Description || "",
                    img: row.ImageURL || "",
                    deaths: row.DeathToll
                })).filter(e => !isNaN(e.lat) && !isNaN(e.lng)); // Оставляем только с координатами

                statusMsg.style.display = 'none';
                updateMap(parseInt(slider.value));

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Ошибка загрузки данных. Проверьте CORS или ссылку.";
                statusMsg.style.background = "#ff4d4d";
            }
        }

        // Обновление карты
        function updateMap(selectedYear) {
            markersLayer.clearLayers();
            
            // Интегративная логика: показываем всё, что случилось <= selectedYear
            const filteredEvents = allEvents.filter(e => e.year <= selectedYear);

            filteredEvents.forEach(e => {
                const radius = getRadius(e.deaths);
                const color = getColor(e.deaths);

                const marker = L.circleMarker([e.lat, e.lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#fff",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.7
                });

                // Формирование HTML для попапа
                let popupHtml = `
                    <div class="popup-content">
                        <h3>${e.title}</h3>
                        <div class="popup-meta">
                            <span>Год: <strong>${e.year}</strong></span>
                            <span>Погибших: <strong>${e.deaths || 'Н/Д'}</strong></span>
                        </div>
                        <div class="popup-info">${e.desc}</div>
                        ${e.img ? `<img src="${e.img}" class="popup-img" alt="${e.title}" onerror="this.style.display='none'">` : ''}
                    </div>
                `;

                marker.bindPopup(popupHtml);
                markersLayer.addLayer(marker);
            });
        }

        // --- 3. Слушатели событий ---
        slider.addEventListener('input', (e) => {
            const year = parseInt(e.target.value);
            yearDisplay.innerText = year;
            updateMap(year);
        });

        // Запуск
        loadData();

    </script>
</body>
</html>